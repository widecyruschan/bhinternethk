<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <title>BHCAM</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="csrf-token" content="jPn1pIU4QrIwYzCAD50Fqkx2tCxNtXijaWWBE1D4"/>


    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700" rel="stylesheet">
    <link rel="stylesheet" href="app.css">

    <link rel="stylesheet" type="text/css" href="voyager.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <style>
    
    video::-webkit-media-controls-play-button {
         display: none;
     }
     video::-webkit-media-controls-timeline {
         
     }
     video::-webkit-media-controls-current-time-display{
         display: none;
     }
video::-webkit-media-controls-time-remaining-display {
    display: none;
}
video::-webkit-media-controls-time-remaining-display {
    display: none;
}

   audio::-webkit-media-controls-timeline,
        video::-webkit-media-controls-timeline {
            display: none;
        }

            audio::-webkit-media-controls-mute-button, video::-webkit-media-controls-mute-button {
    -webkit-appearance: media-mute-button;
    display: -webkit-flex;
}

audio::-webkit-media-controls-closed-captions-container, video::-webkit-media-controls-closed-captions-container {
    display: none;
}
    
        .panel-body row div {
            position: relative;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .dd-placeholder {
            flex: 1;
            width: 100%;
            min-width: 200px;
            max-width: 250px;
        }

        .controlsBtn {
            position: absolute;
            bottom: 10px;
            width: 78%;
            height: 30px;
            left: 10%;
        }

        .controlsBtn .fa-expand-arrows {
            float: right;
        }

        .fas, .fad {
            font-size: 1.4em;;
        }

        input {
            background: #444;
            color: #fff;
            width: 73%;
            font-size: 16px;
            padding-right: 25px;
            border-radius: 15px;;
            padding-left: 20px;
            margin-right: 20px;
            height: 60px;
        }

        .flex-row-container {
            width: 100%;
            display: flex;
        }

        .flex-row-container > .flex-row-item {
            width: 33%;
            margin: 5px;
        }

        .flex-row-container > .flex-row-item video {
            width: 100%;
        }

        #colorbox {
            z-index: 9999999;
        }

        .mb-3 {
            margin-bottom: 1rem;
        }

        /*audio::-webkit-media-controls-timeline,*/
        /*video::-webkit-media-controls-timeline {*/
        /*    display: none;*/
        /*}*/
        
        /* zark */
        video::-webkit-media-controls-play-button {
            display: none;
        }
        video::-webkit-media-controls-current-time-display{
            display: none;
        }
        video::-webkit-media-controls-time-remaining-display {
            display: none;
        }
    </style>
</head>

<body class="voyager">

<div id="voyager-loader" style="left: 125px; display: none;">
    <!--    <img src="https://eventmie.test/admin/voyager-assets?path=images%2Flogo-icon.png" alt="Voyager Loader">-->
</div>

<div class="app-container expanded no-animation" style="">
    <div class="fadetoblack visible-xs"></div>
    <div class="row content-container">
        <div class="container-fluid">
            <div class=" padding-top">
                <div class="container-fluid">
                    <div class="row w-100 p-3 mx-0">
                        <div class="col-12 col-md-12 p-0">
                            <div class="card p-0" style="border-radius: 0.5rem;">
                                <div class="card-header" style="padding: 1rem">
                                    <a class="btn-modal btn btn-sm btn-primary" href="#inline_content" data-strip-caption="" data-strip-group="dorhoutmees">
                                        <i class="fas fa-plus"></i>
                                        Add Capture Device
                                    </a>
                                    <button class="btn-publish btn btn-sm btn-success">Publish</button>
                                    <button class="btn-unpublish btn btn-sm btn-danger" style="display: none">Unpublish</button>
                                </div>
                                <div class="card-body" style="padding: 1rem;">
                                    <div class="flex-row-container">
                                        <div class="flex-row-item">
                                            <video id="camera-1" poster="Film-1.png" class="w-100"
                                                   style="height: 160px;" muted controls autoplay></video>
                                        </div>
                                        <div class="flex-row-item">
                                            <video id="camera-2" poster="Film-2.png" class="w-100"
                                                   style="height: 160px;" muted controls autoplay></video>
                                        </div>
                                        <div class="flex-row-item">
                                            <video id="camera-3" poster="Film-3.png" class="w-100"
                                                   style="height: 160px;" muted controls autoplay></video>
                                        </div>
                                    </div>
                                    <div class="flex-row-container">
                                        <div class="flex-row-item">
                                            <video id="camera-4" poster="Film-4.png" class="w-100"
                                                   style="height: 160px;" muted controls autoplay></video>
                                        </div>
                                        <div class="flex-row-item">
                                            <video id="camera-5" poster="Film-5.png" class="w-100"
                                                   style="height: 160px;" muted controls autoplay></video>
                                        </div>
                                        <div class="flex-row-item">
                                            <video id="camera-6" poster="Film-6.png" class="w-100"
                                                   style="height: 160px;" muted controls autoplay></video>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <div style='display:none'>
        <div id='inline_content' style="background: rgba(0, 0, 0,.9);height:100%;padding:15px;">
            <form id="add-device-form">
                <fieldset class="mb-3">
                    <label class="form-label">For Which Camera</label>
                    <select class="form-control form-select" name="camera">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                    </select>
                </fieldset>

                <fieldset class="mb-3">
                    <label class="form-label">Video Device</label>
                    <select class="form-control form-select" name="video"></select>
                </fieldset>

                <fieldset class="mb-3">
                    <label class="form-label">Audio Device</label>
                    <select class="form-control form-select" name="audio"></select>
                </fieldset>

                <fieldset class="mb-3">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Add Device</button>
                </fieldset>
            </form>
        </div>
    </div>
</div>


<script src="app.js"></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.colorbox/1.6.4/jquery.colorbox-min.js" integrity="sha512-DAVSi/Ovew9ZRpBgHs6hJ+EMdj1fVKE+csL7mdf9v7tMbzM1i4c/jAvHE8AhcKYazlFl7M8guWuO3lDNzIA48A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="sdk.js"></script>
<script>
    $('body').addClass('sidebar-icons');
    $('.main-content').addClass('mt-0 vh-100');
    $('.main-content > .header').remove();
    $('footer').remove();

    $(window).on('load', function (message) {

        let push_urls = {
            1: 'artc://push.binfazil.com/live-streaming/f5d5ce20-be1a-4a3a-99f4-f9283ea0653c',
            2: 'artc://push.binfazil.com/live-streaming/158fe5a8-a984-410a-baf7-586eed50da6b',
            3: 'artc://push.binfazil.com/live-streaming/ff8541ca-7609-4051-99d3-8325531e979c',
            4: 'artc://push.binfazil.com/live-streaming/020c4611-9f44-4107-86ae-5adb87dcb12e',
            5: 'artc://push.binfazil.com/live-streaming/f0883d04-e392-4b32-b90e-92ceddfeed6c',
            6: 'artc://push.binfazil.com/live-streaming/187f03db-dc2e-417b-b72a-0f102beb8d09',
        };

        let pull_urls = {
            1: 'artc://pull.binfazil.com/live-streaming/f5d5ce20-be1a-4a3a-99f4-f9283ea0653c',
            2: 'artc://pull.binfazil.com/live-streaming/158fe5a8-a984-410a-baf7-586eed50da6b',
            3: 'artc://pull.binfazil.com/live-streaming/ff8541ca-7609-4051-99d3-8325531e979c',
            4: 'artc://pull.binfazil.com/live-streaming/020c4611-9f44-4107-86ae-5adb87dcb12e',
            5: 'artc://pull.binfazil.com/live-streaming/f0883d04-e392-4b32-b90e-92ceddfeed6c',
            6: 'artc://pull.binfazil.com/live-streaming/187f03db-dc2e-417b-b72a-0f102beb8d09',
        };

        let cameras = {};
        let published = false;

        $('.btn-modal').colorbox({inline: true, width: "85%"});
        $('[data-bs-dismiss="modal"]').on('click', () => {
            $.colorbox.close()
        });

        startPulling();

        // Start pulling streams
        function startPulling() {

            if (!_.isEmpty(pull_urls)) {
                $.each(pull_urls, async (id, url) => {


                    pullStream(url, (rts, stream) => {
                        cameras[id] = {
                            id: id,
                            rts: rts,
                            stream: stream
                        };

                        console.log(id);
                        const player = document.getElementById('camera-' + id);

                        stream.play(player);
                    });
                });
            }
        }

        function pullStream(url, callback) {
            const rts = new AliRTS.createClient({
                customTag: 'asdsad',
                playConfig: {
                    playTimeOut: null
                }
            });

            rts.subscribe(url)
                .then((stream) => {
                    console.log('pull_stream_success', stream);
                    callback(rts, stream);
                })
                .catch((error) => {
                    console.log('pull_stream_error', error);
                });
        }

        // Listen to modal open, add Video and Audio devices for selection
        $('.btn-modal').on('click', () => {
            const form = $('#add-device-form');

            // Clear all options
            form.find('[name="video"], [name="audio"]').empty();

            // Create options for video and audio devices and append
            navigator.mediaDevices.enumerateDevices().then(function (devices) {
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                const audioDevices = devices.filter(device => device.kind === 'audioinput');

                const videoOptions = videoDevices.map(videoDevice => {
                    return '<option value="' + videoDevice.deviceId + '">' + videoDevice.label + '</option>';
                }).join('');

                const audioOptions = audioDevices.map(audioDevice => {
                    return '<option value="' + audioDevice.deviceId + '">' + audioDevice.label + '</option>';
                }).join('');

                form.find('[name="video"]').append(videoOptions);
                form.find('[name="audio"]').append(audioOptions);
            });
        });

        // Listen to form submit to add a new device
        $('#add-device-form').on('submit', (e) => {
            const form = $('#add-device-form');
            const id = parseInt(form.find('[name="camera"]').val());
            const videoDevice = form.find('[name="video"]').val();
            const audioDevice = form.find('[name="audio"]').val();

            // Disable publish button until stream is ready
            // $('.btn-publish').addClass('disabled').prop('disabled', true);
            // $('.btn-publish').html('<i class="fas fa-spinner fa-pulse">');

            // Add/Update camera constraints
            let constraints = {
                id: id,
                video: {deviceId: videoDevice},
                audio: {deviceId: audioDevice},
            };

            // Create stream from the provided constraints
            createStream(constraints, (stream) => {
                constraints['stream'] = stream;
                stream.play(document.getElementById('camera-' + id));

                // Update camera constraints
                cameras[id] = constraints;

                // If already published, publish the stream straight away
                if (published) {
                    console.log("video is published",published);
                    // pushStream(push_urls[id], stream, function (rts, response) {
                    //     PusherMultiClass.sendEvent({
                    //         event: '1',
                    //         id: id
                    //     });
                    //
                    //     cameras[id]['rts'] = rts;
                    // });
                }

                // Enable publish button as the stream is ready now
                $('.btn-publish').removeClass('disabled').prop('disabled', false);
                $('.btn-publish').html('Publish');
            });

            // Hide modal
            $.colorbox.close()

            return false;
        });

        $('.btn-publish').on('click', (e) => {
            const btn = $(e.currentTarget);
            // btn.addClass('disabled').prop('disabled', true);
            // btn.html('<i class="fas fa-spinner fa-pulse">');

            if (!_.isEmpty(cameras)) {
                $.each(cameras, (i, camera) => {
                    // Get push url for the stream
                    const url = push_urls[camera.id];

                    // Push stream to users
                    pushStream(url, camera.stream, function (rts, response) {
                        btn.hide();
                        btn.removeClass('disabled').prop('disabled', false);
                        btn.html('Publish');
                        $('.btn-unpublish').show();

                        // PusherMultiClass.sendEvent({
                        //     event: '1',
                        //     id: camera.id
                        // });

                        camera['rts'] = rts;

                        published = true;
                    });
                });

                return false;
            }

            alert('Please add a capture device first!')
        });

        $('.btn-push').on('click', (e) => {
            const btn = $(e.currentTarget);
            btn.addClass('disabled').prop('disabled', true);
            btn.html('<i class="fas fa-spinner fa-pulse">');

            btn.removeClass('disabled').prop('disabled', false);
            btn.html('Start Pushing to Users');
        });

        $('.btn-unpublish').on('click', (e) => {
            const btn = $(e.currentTarget);
            btn.addClass('disabled').prop('disabled', true);
            btn.html('<i class="fas fa-spinner fa-pulse">');

            if (!_.isEmpty(cameras)) {
                $.each(cameras, async (i, camera) => {
                    const rts = camera['rts'];
                    const stream = camera['stream'];

                    // Unpublish stream
                    await rts.unpublish();

                    published = false;

                    // Switch button
                    btn.hide();
                    btn.removeClass('disabled').prop('disabled', false);
                    btn.html('Unpublish');
                    $('.btn-publish').show();
                });
            }
        });

        // Create stream from the provided constrains
        function createStream(constraints, callback) {

            new AliRTS
                .createStream(constraints)
                .then(async (stream) => {
                    // Set stream resolution
                    await stream.setVideoProfile('720p_1');
                    // await stream.setVideoProfile('120p_1');

                    console.log('create_stream_success', stream);
                    callback(stream)
                })
                .catch((err) => {
                    console.log('create_stream_error', err);
                });
        }

        // Push stream to the provided url and play inside the provided player
        function pushStream(url, stream, callback) {

            const rts = new AliRTS.createClient({
                customTag: 'asdsad',
                playConfig: {
                    playTimeOut: 9999999
                }
            });

            rts.publish(url, stream)
                .then((response) => {
                    console.log('push_stream_success', response);
                    callback(rts, response);
                })
                .catch((error) => {
                    console.log('push_stream_error', error);
                });
        }
    });

</script>
</body>
</html>
